<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Refynd WebSocket Rate Limiting Demo</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .container {
            margin-bottom: 20px;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .connected { background-color: #d4edda; color: #155724; }
        .disconnected { background-color: #f8d7da; color: #721c24; }
        .rate-limited { background-color: #fff3cd; color: #856404; }
        .messages {
            height: 300px;
            border: 1px solid #ccc;
            padding: 10px;
            overflow-y: auto;
            margin: 10px 0;
        }
        .controls {
            display: flex;
            gap: 10px;
            margin: 10px 0;
        }
        button {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .primary { background-color: #007bff; color: white; }
        .secondary { background-color: #6c757d; color: white; }
        .danger { background-color: #dc3545; color: white; }
        .warning { background-color: #ffc107; color: #212529; }
        input {
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            flex: 1;
        }
        .rate-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <h1>Refynd WebSocket Rate Limiting Demo</h1>
    
    <div class="container">
        <div id="status" class="status disconnected">Disconnected</div>
        
        <div class="rate-info">
            <span>Remaining Requests: <strong id="remaining-requests">--</strong></span>
            <span>Connected Clients: <strong id="connected-clients">--</strong></span>
            <span>Blocked Clients: <strong id="blocked-clients">--</strong></span>
        </div>
        
        <div class="controls">
            <button id="connect" class="primary">Connect</button>
            <button id="disconnect" class="secondary" disabled>Disconnect</button>
            <button id="stats" class="secondary" disabled>Get Stats</button>
            <button id="stress-test" class="warning" disabled>Stress Test (Send 10 fast)</button>
        </div>
        
        <div class="controls">
            <input type="text" id="channel" placeholder="Channel name" value="general">
            <button id="join" class="primary" disabled>Join Channel</button>
            <button id="leave" class="secondary" disabled>Leave Channel</button>
        </div>
        
        <div class="controls">
            <input type="text" id="message" placeholder="Enter message">
            <button id="send" class="primary" disabled>Send Message</button>
        </div>
        
        <div id="messages" class="messages"></div>
    </div>

    <script>
        class RateLimitedWebSocketDemo {
            constructor() {
                this.ws = null;
                this.remainingRequests = null;
                this.setupEventListeners();
            }

            setupEventListeners() {
                document.getElementById('connect').addEventListener('click', () => this.connect());
                document.getElementById('disconnect').addEventListener('click', () => this.disconnect());
                document.getElementById('stats').addEventListener('click', () => this.getStats());
                document.getElementById('stress-test').addEventListener('click', () => this.stressTest());
                document.getElementById('join').addEventListener('click', () => this.joinChannel());
                document.getElementById('leave').addEventListener('click', () => this.leaveChannel());
                document.getElementById('send').addEventListener('click', () => this.sendMessage());
                
                document.getElementById('message').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        this.sendMessage();
                    }
                });
            }

            connect() {
                if (this.ws) {
                    return;
                }

                this.ws = new WebSocket('ws://localhost:8080');
                
                this.ws.onopen = () => {
                    this.updateStatus('Connected', 'connected');
                    this.updateButtons(true);
                    this.log('Connected to WebSocket server');
                };

                this.ws.onmessage = (event) => {
                    const message = JSON.parse(event.data);
                    this.handleMessage(message);
                };

                this.ws.onclose = () => {
                    this.updateStatus('Disconnected', 'disconnected');
                    this.updateButtons(false);
                    this.log('Disconnected from WebSocket server');
                    this.ws = null;
                };

                this.ws.onerror = (error) => {
                    this.log('WebSocket error: ' + error.message, 'error');
                };
            }

            disconnect() {
                if (this.ws) {
                    this.ws.close();
                }
            }

            handleMessage(message) {
                switch (message.type) {
                    case 'rate_limit_error':
                        this.handleRateLimit(message);
                        break;
                    case 'status':
                        this.handleStatus(message);
                        break;
                    case 'stats':
                        this.handleStats(message);
                        break;
                    default:
                        this.log('Received: ' + JSON.stringify(message));
                        break;
                }

                // Update rate limit info if present
                if (message.rate_limit) {
                    this.updateRateLimit(message.rate_limit.remaining_requests);
                }
            }

            handleRateLimit(error) {
                this.updateStatus('Rate Limited - ' + error.message, 'rate-limited');
                this.log(`Rate Limited: ${error.message}`, 'error');
                
                if (error.blocked_until) {
                    this.log(`Blocked until: ${error.blocked_until}`, 'error');
                }

                this.updateRateLimit(error.remaining_requests);
            }

            handleStatus(message) {
                this.log(`${message.action} channel: ${message.channel}`, 'success');
            }

            handleStats(message) {
                this.log('Server Statistics:', 'info');
                this.log(`Connected Clients: ${message.server.connected_clients}`, 'info');
                this.log(`Channels: ${message.server.channels}`, 'info');
                this.log(`Rate Limiter - Active: ${message.rate_limiter.active_clients}, Blocked: ${message.rate_limiter.blocked_clients}`, 'info');
                
                document.getElementById('connected-clients').textContent = message.server.connected_clients;
                document.getElementById('blocked-clients').textContent = message.rate_limiter.blocked_clients;
            }

            getStats() {
                if (this.ws && this.ws.readyState === WebSocket.OPEN) {
                    this.ws.send(JSON.stringify({ type: 'stats' }));
                }
            }

            joinChannel() {
                const channel = document.getElementById('channel').value;
                if (this.ws && this.ws.readyState === WebSocket.OPEN && channel) {
                    this.ws.send(JSON.stringify({ type: 'join', channel: channel }));
                }
            }

            leaveChannel() {
                const channel = document.getElementById('channel').value;
                if (this.ws && this.ws.readyState === WebSocket.OPEN && channel) {
                    this.ws.send(JSON.stringify({ type: 'leave', channel: channel }));
                }
            }

            sendMessage() {
                const messageInput = document.getElementById('message');
                const channel = document.getElementById('channel').value;
                const message = messageInput.value;

                if (this.ws && this.ws.readyState === WebSocket.OPEN && message) {
                    // Check if we're approaching rate limit
                    if (this.remainingRequests !== null && this.remainingRequests <= 5) {
                        this.log(`Warning: Only ${this.remainingRequests} requests remaining`, 'warning');
                    }

                    this.ws.send(JSON.stringify({
                        type: 'message',
                        channel: channel,
                        data: message
                    }));
                    
                    messageInput.value = '';
                    this.log(`Sent to ${channel}: ${message}`);
                }
            }

            stressTest() {
                let count = 0;
                const interval = setInterval(() => {
                    if (count >= 10 || !this.ws || this.ws.readyState !== WebSocket.OPEN) {
                        clearInterval(interval);
                        return;
                    }

                    this.ws.send(JSON.stringify({
                        type: 'message',
                        channel: 'stress-test',
                        data: `Stress test message ${count + 1}`
                    }));
                    
                    count++;
                }, 100); // Send every 100ms
            }

            updateStatus(message, className) {
                const status = document.getElementById('status');
                status.textContent = message;
                status.className = `status ${className}`;
            }

            updateButtons(connected) {
                document.getElementById('connect').disabled = connected;
                document.getElementById('disconnect').disabled = !connected;
                document.getElementById('stats').disabled = !connected;
                document.getElementById('stress-test').disabled = !connected;
                document.getElementById('join').disabled = !connected;
                document.getElementById('leave').disabled = !connected;
                document.getElementById('send').disabled = !connected;
            }

            updateRateLimit(remaining) {
                this.remainingRequests = remaining;
                document.getElementById('remaining-requests').textContent = remaining;
                
                // Update UI based on rate limit status
                if (remaining <= 5) {
                    document.getElementById('remaining-requests').style.color = '#dc3545';
                } else if (remaining <= 15) {
                    document.getElementById('remaining-requests').style.color = '#ffc107';
                } else {
                    document.getElementById('remaining-requests').style.color = '#28a745';
                }
            }

            log(message, type = 'info') {
                const messages = document.getElementById('messages');
                const timestamp = new Date().toLocaleTimeString();
                const div = document.createElement('div');
                
                let color = '#333';
                switch (type) {
                    case 'error': color = '#dc3545'; break;
                    case 'success': color = '#28a745'; break;
                    case 'warning': color = '#ffc107'; break;
                    case 'info': color = '#007bff'; break;
                }
                
                div.innerHTML = `<span style="color: #666;">[${timestamp}]</span> <span style="color: ${color};">${message}</span>`;
                messages.appendChild(div);
                messages.scrollTop = messages.scrollHeight;
            }
        }

        // Initialize the demo
        new RateLimitedWebSocketDemo();
    </script>
</body>
</html>
